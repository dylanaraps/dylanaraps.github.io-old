#!/usr/bin/env bash
#
# Turn a collection of markdown files into a website.

gen_html() {
    [[ "$1" ]] && mkdir -p "$1" || return

    for page in src/"$1"/*.md; do
        dir="${page/src}"
        printf "%s\n" "Generating .${dir/\.md}.html..."

        # Generate html files.
        pandoc -o ".${dir/\.md}.html" --template "src/templates/post.html" --smart -- "$page"

        # Minify html files.
        sed -i 's/^[ \t]*//g; s/[ \t]*$//g;' ".${dir/\.md}.html"
        sed -i ':a;N;$!ba;s/\n/ /g' ".${dir/\.md}.html"
    done
}

gen_css() {
    [[ "$1" ]] && mkdir -p "$1" || return

    for css in src/"$1"/*.scss; do
        dir="${css/src}"
        printf "%s\n" "Generating .${dir/\.scss}.css..."
        sassc --style compressed -- "$css" > ".${dir/\.scss}.css"
    done
}

# Generate pages.
gen_html "pages" &
gen_html "pages/rice" &
gen_html "." &

# Minify css.
gen_css "css" &

# Wait for script to finish.
wait
